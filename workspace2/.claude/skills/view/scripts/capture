#!/bin/bash
# go2rtc経由でカメラ画像を取得し、LLM入力に適したサイズにリサイズするスクリプト
#
# 使用例:
#   capture                    # 標準出力にJPEG画像を出力
#   capture -o output.jpg      # ファイルに保存
#   capture -w 640 -h 480      # サイズ指定
#   capture -s tapo_tc70       # ストリーム名指定

set -e

# .envファイルから環境変数を読み込む
load_env_file() {
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local current_dir="$script_dir"
    local env_file=""

    # 上に遡って.envを探す（最大10階層）
    for i in {1..10}; do
        if [[ -f "${current_dir}/.env" ]]; then
            env_file="${current_dir}/.env"
            break
        fi
        # 親ディレクトリへ移動
        current_dir="$(dirname "$current_dir")"
        # ルートディレクトリに到達したら終了
        if [[ "$current_dir" == "/" ]]; then
            break
        fi
    done

    if [[ -f "${env_file}" ]]; then
        while IFS='=' read -r key value; do
            # コメント行と空行をスキップ
            [[ "${key}" =~ ^#.*$ ]] && continue
            [[ -z "${key}" ]] && continue
            # 値から引用符を削除
            value=$(echo "${value}" | sed 's/^[[:space:]]*"//;s/"[[:space:]]*$//;s/^[[:space:]]*'"'"'//;s/[[:space:]]*'"'"'$//')
            # 既存の環境変数を上書きしない
            [[ -z "${!key}" ]] && export "${key}=${value}"
        done < "${env_file}"
    fi
}

load_env_file

# デフォルト設定
GO2RTC_HOST="${GO2RTC_HOST:-localhost}"
GO2RTC_API_PORT="${GO2RTC_API_PORT:-1984}"
GO2RTC_RTSP_PORT="${GO2RTC_RTSP_PORT:-8554}"
STREAM="${STREAM:-tapo_tc70}"
WIDTH="${WIDTH:-640}"
HEIGHT="${HEIGHT:-480}"
OUTPUT="${OUTPUT:-}"
QUALITY="${QUALITY:-85}"
WORKSPACE_MEDIA="${WORKSPACE_MEDIA:-/home/tane/dev/AI/yatagarasu/workspace2/media}"

# ヘルプメッセージ
show_help() {
    cat << EOF
使用法: $(basename "$0") [オプション]

オプション:
    -s, --stream NAME     ストリーム名 (デフォルト: tapo_tc70)
    -w, --width WIDTH     出力幅 (デフォルト: 640)
    -h, --height HEIGHT   出力高さ (デフォルト: 480)
    -q, --quality QUALITY JPEG品質 1-100 (デフォルト: 85)
    -o, --output FILE     出力ファイル (デフォルト: 標準出力)
    --host HOST           go2rtcホスト (デフォルト: localhost)
    --rtsp-port PORT      RTSPポート (デフォルト: 8554)
    -h, --help            このヘルプを表示

環境変数:
    GO2RTC_HOST           go2rtcホスト
    GO2RTC_RTSP_PORT      RTSPポート
    STREAM                ストリーム名
    WIDTH                 出力幅
    HEIGHT                出力高さ
    QUALITY               JPEG品質
    OUTPUT                出力ファイル

例:
    $(basename "$0")                    # 標準出力にJPEG
    $(basename "$0") -o photo.jpg       # ファイルに保存
    $(basename "$0") -w 1280 -h 720     # HDサイズ
    STREAM=front_camera $(basename "$0") # 環境変数でストリーム指定
EOF
}

# 引数解析
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--stream)
            STREAM="$2"
            shift 2
            ;;
        -w|--width)
            WIDTH="$2"
            shift 2
            ;;
        -h|--height)
            HEIGHT="$2"
            shift 2
            ;;
        -q|--quality)
            QUALITY="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT="$2"
            shift 2
            ;;
        --host)
            GO2RTC_HOST="$2"
            shift 2
            ;;
        --rtsp-port)
            GO2RTC_RTSP_PORT="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo "エラー: 不明なオプション: $1" >&2
            show_help
            exit 1
            ;;
    esac
done

# 一時ファイル
TEMP_FILE=$(mktemp --suffix=.jpg)
trap "rm -f ${TEMP_FILE}" EXIT

# go2rtcのRTSP URL
RTSP_URL="rtsp://${GO2RTC_HOST}:${GO2RTC_RTSP_PORT}/${STREAM}"

# ffmpegでストリームから1フレーム取得
if ! ffmpeg -loglevel error -t 1 -i "${RTSP_URL}" -frames:v 1 -q:v "${QUALITY}" -vf "scale=${WIDTH}:${HEIGHT}:force_original_aspect_ratio=decrease,pad=${WIDTH}:${HEIGHT}:(ow-iw)/2:(oh-ih)/2" -y "${TEMP_FILE}" 2>/dev/null; then
    echo "エラー: go2rtcから画像を取得できませんでした: ${RTSP_URL}" >&2
    echo "ヒント: go2rtcが起動しているか、ストリーム名が正しいか確認してください" >&2
    exit 1
fi

# 出力
if [[ -n "${OUTPUT}" ]]; then
    # 相対パスの場合はworkspace/media配下に配置
    if [[ "${OUTPUT}" != /* ]]; then
        OUTPUT="${WORKSPACE_MEDIA}/${OUTPUT}"
    fi
    mkdir -p "$(dirname "${OUTPUT}")"
    mv "${TEMP_FILE}" "${OUTPUT}"
    echo "画像を保存しました: ${OUTPUT} (${WIDTH}x${HEIGHT})" >&2
else
    # 出力指定がない場合はworkspace/mediaにタイムスタンプ付きで保存
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    OUTPUT="${WORKSPACE_MEDIA}/capture_${TIMESTAMP}.jpg"
    mkdir -p "$(dirname "${OUTPUT}")"
    mv "${TEMP_FILE}" "${OUTPUT}"
    echo "画像を保存しました: ${OUTPUT} (${WIDTH}x${HEIGHT})" >&2
fi
