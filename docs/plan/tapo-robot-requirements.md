# Tapo Robot 要件定義 v0.2

- 更新日: 2026-02-24
- 対象: Tapo見守りカメラを利用した対話ロボット基盤
- 目的: 既存実装を壊さず、追加機能を段階的に実装できる構造を定義する

## 1. スコープ

### 1.1 スコープ内

- 発声（`speak`）
- カメラ移動（`move-camera`）
- 映像取得（`view`）
- 音声取得と文字起こし（`listend`）
- ウェイク/スリープ状態遷移
- 動体検知トリガ
- オーケストレーション（推論起動、スキル呼び出し）
- 記憶（Semantic Memory）連携
- 設定と秘密情報の外部化

### 1.2 スコープ外（現時点）

- 複数カメラ同時制御
- クラウド分散実行
- 高度な物体追跡アルゴリズム

## 2. システムゴール

- 常時待機可能なローカルAIロボットを構築する。
- 反応速度と堅牢性を両立する。
- 機密情報（パスワード、トークン）をコードから分離する。

## 3. 機能要件

### FR-01 発声 `speak`（完了）

- VoiceVox経由で音声を生成できること。
- 低遅延再生を優先し、既存の堅牢性（順序保証、出力整合）を維持すること。

### FR-02 カメラ移動 `move-camera`（完了）

- 左右上下移動、座標指定移動、キャリブレーションが実行できること。
- 認証情報を環境変数経由で与えられること。

### FR-03 映像取得 `view`（完了）

- カメラ映像の取得コマンドを提供すること。
- オーケストレーションから呼び出せること。

### FR-04 音声取得 `listend`

- RTSPから音声を取り込み、STTバックエンドを切替できること。
  - `faster-whisper`（初期値 `base`）
  - `ReazonSpeech k2`（任意切替）
- 有音を検知し、ON状態時は逐次テキストをAIトリガとして渡せること。
- wake/stop判定は文字起こし結果で行うこと。

### FR-05 ウェイク/スリープ状態管理

- Wakeワードを含む発話で `OFF -> ON` 遷移すること。
- Sleepワードで `ON -> OFF` 遷移すること。
- `ON` 状態で無音が一定時間続いた場合は `OFF` に戻ること（設定値、既定30秒）。
- `ON` 状態で無音が一定時間続いたら、1ターン確定して dispatch できること（設定値、既定3秒）。

### FR-06 動体検知トリガ `motiond`

- systemd常駐で動体検知を監視すること。
- 動体イベント時に、映像取得 -> 状況判断 -> 発話の固定プロンプトを実行すること。

### FR-07 オーケストレーション

- トリガ入力（音声/動体/定時）を受け、単一の推論パイプラインに流すこと。
- 直近記憶を読み出し、文字起こしと合わせて推論入力に組み込むこと。
- 推論結果に従って `speak` と記憶保存スキルを呼び出すこと。

### FR-08 記憶 `SemanticMemory`

- 直近会話文脈と長期記憶を分離して保存できること。
- 「必要時に思い出す」検索インタフェースを提供すること。

### FR-09 ウェイクアップ方式

- 以下3経路をサポートすること。
1. 定時起動（cronまたはsystemd timer）
2. 音声ウェイクワード
3. 動体検知

### FR-10 設定と機密情報管理

- 設定は `YATAGARASU_CWD/.env` に集約すること（標準運用例: `workspace/.env`）。
- スクリプト直書きの秘密情報を禁止すること。

## 4. 非機能要件

### NFR-01 可用性

- 各デーモンは異常終了時に自動再起動されること。
- ネットワーク断時に復帰可能な再接続戦略を持つこと。

### NFR-02 応答性

- 音声応答は「最初の返答を早く出す」設計を優先すること。
- 長文応答時は逐次再生を許可すること。

### NFR-03 保守性

- モジュール責務を分離し、トリガ/推論/デバイス制御を独立テストできること。
- コマンドI/Fを安定化し、AI側からの呼び出し仕様を固定化すること。

### NFR-04 監査性

- 主要イベント（wake/sleep、推論起動、スキル実行、エラー）を時系列ログ化すること。

## 5. 状態遷移要件（音声）

- 初期状態は `OFF`。
- `OFF` で wakeワード検知時、`ON` に遷移しセッション開始。
- `ON` で sleepワード検知時、`OFF` に遷移しセッション終了。
- `ON` で無音タイムアウト（既定30秒）時、`OFF` に遷移。

## 6. オーケストレーション実行要件

- バッチ起動コマンド例:
  - `claude -p "<prompt>" --model haiku --continue --allowedTools "Read,Edit,Bash"`
- 入力テンプレートには以下を含むこと。
1. トリガ種別（voice/motion/cron）
2. 文字起こし本文または検知要約
3. 直近記憶の要約
4. 呼び出し可能スキル一覧

## 7. 受け入れ条件（初期）

- 音声ウェイクでON遷移し、発話内容をAIに渡せること。
- 無音タイムアウトでOFFに戻ること。
- 動体検知イベントで固定プロンプト推論が起動し発話できること。
- 機密情報がリポジトリに含まれないこと（`.env` 直管理なし）。
