#!/bin/bash
# Yatagarasu - 八咫烏: Claude Code ずんだもん発声スクリプト
# Claude Codeにプロンプトを渡し、その応答をずんだもんが喋ります
# SemanticMemoryによる記憶機能付き

# スクリプトのディレクトリを取得
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 呼び出し元のワーキングディレクトリを保存（再帰呼び出し用）
export YATAGARASU_CWD="${YATAGARASU_CWD:-$(pwd)}"

# .envファイルから環境変数を読み込む
load_env_file() {
    local project_root="$(dirname "$SCRIPT_DIR")"
    local workspace="${YATAGARASU_CWD:-$project_root/workspace}"
    local env_file=""

    # workspace/.envを優先、なければプロジェクトルートの.env
    if [[ -f "${workspace}/.env" ]]; then
        env_file="${workspace}/.env"
    elif [[ -f "${project_root}/.env" ]]; then
        env_file="${project_root}/.env"
    fi

    if [[ -f "${env_file}" ]]; then
        while IFS='=' read -r key value; do
            [[ "${key}" =~ ^#.*$ ]] && continue
            [[ -z "${key}" ]] && continue
            value=$(echo "${value}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^"//;s/"$//;s/^'"'"'//;s/'"'"'$//')
            [[ -z "${!key}" ]] && export "${key}=${value}"
        done < "${env_file}"
    fi
}

load_env_file

# デフォルト値（.envで設定可能）
MODEL="${YATAGARASU_MODEL:-haiku}"
SPEAKER="${YATAGARASU_SPEAKER:-68}"
# SemanticMemory設定
MEMORY_ENABLED="${YATAGARASU_MEMORY_ENABLED:-true}"

# ヘルプメッセージ
usage() {
    echo "使用法: $0 [オプション] [テキスト]" >&2
    echo "" >&2
    echo "引数:" >&2
    echo "  テキスト                 Claudeに送るプロンプト（オプション）" >&2
    echo "                          指定しない場合は標準入力から読み込み" >&2
    echo "" >&2
    echo "オプション:" >&2
    echo "  -m, --model MODEL      Claudeモデル (デフォルト: haiku)" >&2
    echo "                         利用可能なモデル: haiku, sonnet, opus" >&2
    echo "  -s, --speaker ID       ずんだもんスピーカーID (デフォルト: 68)" >&2
    echo "                         主なスピーカー:" >&2
    echo "                           46: 小夜/SAYO" >&2
    echo "                           68: あいえるたん" >&2
    echo "                           0: 四国めたん" >&2
    echo "                           1: ずんだもん" >&2
    echo "  --no-memory            記憶機能を無効化" >&2
    echo "  -h, --help             このヘルプメッセージを表示" >&2
    echo "" >&2
    echo "環境変数 (.env):" >&2
    echo "  SEMANTIC_MEMORY_ENABLED      記憶機能の有効/無効 (デフォルト: true)" >&2
    echo "  SEMANTIC_MEMORY_RECENT_LIMIT 過去の文脈取得件数 (デフォルト: 3)" >&2
    echo "  SEMANTIC_MEMORY_RECALL_LIMIT 関連知識取得件数 (デフォルト: 3)" >&2
    echo "" >&2
    echo "使用例:" >&2
    echo "  $0 \"今日は天気がいいから、公園とかに行くと気持ちいいかな？\"" >&2
    echo "  $0 \"こんにちは\" -m sonnet -s 1" >&2
    echo "  echo \"こんにちは\" | $0 -s 1" >&2
    exit 1
}

# 引数解析
POSITIONAL_ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -m|--model)
            if [ -n "$2" ] && [[ "$2" != -* ]]; then
                MODEL="$2"
                shift 2
            else
                echo "エラー: -m オプションにはモデル名が必要です。" >&2
                usage
            fi
            ;;
        -s|--speaker)
            if [ -n "$2" ] && [[ "$2" != -* ]]; then
                SPEAKER="$2"
                shift 2
            else
                echo "エラー: -s オプションにはスピーカーIDが必要です。" >&2
                usage
            fi
            ;;
        --no-memory)
            MEMORY_ENABLED="false"
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

# プロンプトの取得（優先順位: 位置引数 > 標準入力）
if [ ${#POSITIONAL_ARGS[@]} -gt 0 ]; then
    # 位置引数を結合
    PROMPT="${POSITIONAL_ARGS[*]}"
elif [ ! -t 0 ]; then
    # 標準入力から読み込み
    PROMPT=$(cat)
else
    echo "エラー: プロンプトが指定されていません。" >&2
    echo "テキストを引数に指定するか、標準入力から渡してください。" >&2
    usage
fi

# プロンプトが空でないかチェック
if [ -z "$PROMPT" ]; then
    echo "エラー: プロンプトが空です。" >&2
    exit 1
fi

# 記憶コンテキストを取得
MEMORY_CONTEXT=""
if [[ "$MEMORY_ENABLED" == "true" ]]; then
    MEMORY_CONTEXT=$("$SCRIPT_DIR/recall-context.sh" "$PROMPT" 2>/dev/null) || MEMORY_CONTEXT=""
fi

# システムプロンプトを構築
SYSTEM_PROMPT="$PROMPT"

if [[ -n "$MEMORY_CONTEXT" ]]; then
    # 記憶コンテキストをシステムプロンプトに追加
    SYSTEM_PROMPT=$(cat <<EOF

以下は過去の会話の記憶と関連知識です。これらを参考にしつつ、現在のプロンプトに応答してください。

$MEMORY_CONTEXT

---
現在のプロンプト: $PROMPT
EOF
)
fi

# Claude Codeの応答を取得
RESPONSE=$(YATAGARASU_CWD="$YATAGARASU_CWD" claude -p "$SYSTEM_PROMPT" --model "$MODEL" --allowedTools "Read,Edit,Bash" --permission-mode bypassPermissions 2>/dev/null)

# 応答を保存してずんだもんで喋らせる
echo "$RESPONSE" | "$SCRIPT_DIR/zunda" --stdout -s "$SPEAKER" | "$SCRIPT_DIR/tapovoice"

# 会話を記憶に保存
if [[ "$MEMORY_ENABLED" == "true" ]] && [[ -n "$RESPONSE" ]]; then
    CONVERSATION="[user]${PROMPT}"$'\n'"[agent]${RESPONSE}"
    "$SCRIPT_DIR/memorize.sh" "$CONVERSATION" --no-summarize >/dev/null 2>&1 || true
fi
